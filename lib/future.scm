;
; single-assignment data-flow variable
;

(import dev "./dev.asm")

(define future-beh
    (lambda (waiting)  ; initially ()
        (BEH (op arg)  ; ('read cust) | ('write value)
            (cond
                ((eq? op 'read)
                    (BECOME (future-beh (cons arg waiting))))
                ((eq? op 'write)
                    (BECOME (value-beh arg))
                    (send-to-all waiting arg)) ))))

(define value-beh
    (lambda (value)
        (BEH (op arg)
            (cond
                ((eq? op 'read)
                    (SEND arg value))))))

(define send-to-all
    (lambda (waiting value)
        (cond
            ((pair? waiting)
                (SEND (car waiting) value)
                (send-to-all (cdr waiting) value)) )))

(define start
    (lambda (cust future)
        (SEND future (list 'read cust))
        (SEND future (list 'write 420))
        (SEND future (list 'read cust))
        (SEND future (list 'write -42))
        (SEND future (list 'read cust))
        (SEND future (list 'read cust)) ))

(start (DEVICE dev.debug_key) (CREATE (future-beh '())))

(define beh future-beh)  ; module default alias
(export beh future-beh)
